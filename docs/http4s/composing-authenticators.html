<html><head><title>TSec</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Jose Cardona" /><meta name="description" content="A Type-Safe General Cryptography Library on the JVM" /><meta name="og:image" content="/tsec/img/poster.png" /><meta name="og:title" content="TSec" /><meta name="og:site_name" content="TSec" /><meta name="og:url" content="https://jmcardon.github.io/tsec/" /><meta name="og:type" content="website" /><meta name="og:description" content="A Type-Safe General Cryptography Library on the JVM" /><link rel="icon" type="image/png" href="/tsec/img/favicon.png" /><meta name="twitter:title" content="TSec" /><meta name="twitter:image" content="https://jmcardon.github.io/tsec/img/poster.png" /><meta name="twitter:description" content="A Type-Safe General Cryptography Library on the JVM" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/tsec/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/tsec/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/tsec/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/tsec/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/tsec/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/tsec/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/tsec/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/tsec/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/tsec/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/tsec/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/tsec/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/tsec/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/tsec/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/tsec/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/tsec/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/tsec/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/tsec/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/tsec/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/tsec/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/tsec/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/tsec/highlight/styles/default.css" /><link rel="stylesheet" href="/tsec/css/style.css" /><link rel="stylesheet" href="/tsec/css/palette.css" /><link rel="stylesheet" href="/tsec/css/codemirror.css" /><link rel="stylesheet" href="/tsec/css/kazari-style.css" /><link rel="stylesheet" href="/tsec/css/monokai.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/tsec/" class="brand"><div class="brand-wrapper"><span>TSec</span></div></a></li> <li><a href="/tsec/docs/symmetric.html" class="">Symmetric Ciphers</a></li> <li><a href="/tsec/docs/messagedigests.html" class="">Message Digests</a></li> <li><a href="/tsec/docs/passwordhashers.html" class="">Password Hashers</a></li> <li><a href="/tsec/docs/mac.html" class="">Message Authentication</a></li> <li><a href="/tsec/docs/jwt-mac.html" class="">JWT</a></li> <li><a href="/tsec/docs/http4s-auth.html" class="">Http4s-Auth</a> <ul class="sub_section"> <li><a href="/tsec/docs/http4s-auth.html" class="">Overview</a></li> <li><a href="/tsec/docs/http4s/auth-scookie.html" class="">Signed Cookies</a></li> <li><a href="/tsec/docs/http4s/auth-ecookie.html" class="">Encrypted Cookies</a></li> <li><a href="/tsec/docs/http4s/auth-jwt.html" class="">JWT</a></li> <li><a href="/tsec/docs/http4s/auth-bearer.html" class="">Bearer Token</a></li> <li><a href="/tsec/docs/http4s/composing-authenticators.html" class=" active ">Composing Authenticators</a></li> <li><a href="/tsec/docs/http4s/authorization.html" class="">Authorization</a></li> <li><a href="/tsec/docs/http4s/csrf.html" class="">CSRF</a></li></ul></li> <li><a href="/tsec/docs/common.html" class="">Common Utils</a></li> <li><a href="/tsec/docs/signatures.html" class="">Digital Signatures</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/jmcardon/tsec"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/jmcardon/tsec"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('TSec A Type-Safe General Cryptography Library on the JVM');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('TSec A Type-Safe General Cryptography Library on the JVM');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="jmcardon" data-github-repo="tsec"><div class="content-wrapper"><section><h1 id="composing-authenticators">Composing Authenticators</h1>

<p>Since <code class="highlighter-rouge">0.0.1-M5</code>, all <code class="highlighter-rouge">Authenticators</code> have a common interface:</p>

<div class="language-scala highlighter-rouge"><pre class="codehilite"><code><span class="k">trait</span> <span class="nc">Authenticator</span><span class="o">[</span><span class="kt">I</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">identity</span><span class="k">:</span> <span class="kt">I</span>
  <span class="k">val</span> <span class="n">expiry</span><span class="k">:</span> <span class="kt">Instant</span>
  <span class="k">val</span> <span class="n">lastTouched</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Instant</span><span class="o">]</span>

  <span class="k">def</span> <span class="n">isExpired</span><span class="o">(</span><span class="n">now</span><span class="k">:</span> <span class="kt">Instant</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="n">expiry</span><span class="o">.</span><span class="n">isBefore</span><span class="o">(</span><span class="n">now</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">isTimedout</span><span class="o">(</span><span class="n">now</span><span class="k">:</span> <span class="kt">Instant</span><span class="o">,</span> <span class="n">timeOut</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span>
    <span class="n">lastTouched</span><span class="o">.</span><span class="n">exists</span><span class="o">(</span>
      <span class="k">_</span><span class="o">.</span><span class="n">plusSeconds</span><span class="o">(</span><span class="n">timeOut</span><span class="o">.</span><span class="n">toSeconds</span><span class="o">)</span>
        <span class="o">.</span><span class="n">isBefore</span><span class="o">(</span><span class="n">now</span><span class="o">)</span>
    <span class="o">)</span>
<span class="o">}</span>
</code></pre></div>

<p>However, authenticators themselves tend to vary very differently in structure. The structure <code class="highlighter-rouge">AugmentedJWT</code> implements
this auth is different to a <code class="highlighter-rouge">TSecBearerToken</code>.</p>

<p>This means that, in the case that you must use different token types for a particular endpoint,
you can choose to compose authenticators, at the cost of losing a tad bit of type information.</p>

<p>As an example, letâ€™s bring in different types of authenticators:</p>

<div class="language-scala highlighter-rouge"><pre class="codehilite"><code><span class="k">import</span> <span class="nn">cats.data.OptionT</span>
<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="k">import</span> <span class="nn">org.http4s._</span>
<span class="k">import</span> <span class="nn">org.http4s.dsl.io._</span>
<span class="k">import</span> <span class="nn">org.http4s.headers.</span><span class="o">{</span><span class="nc">Authorization</span> <span class="k">=&gt;</span> <span class="n">H4SA</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">tsec.common.SecureRandomId</span>
<span class="k">import</span> <span class="nn">tsec.jws.mac.JWTMacM</span>
<span class="k">import</span> <span class="nn">tsec.mac.imports.HMACSHA256</span>
<span class="k">import</span> <span class="nn">tsec.authentication._</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">DummyUser</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"bob"</span><span class="o">)</span>

<span class="k">def</span> <span class="n">jwtAuthenticator</span><span class="k">:</span> <span class="kt">StatefulJWTAuthenticator</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span>, <span class="kt">DummyUser</span>, <span class="kt">HMACSHA256</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

<span class="k">def</span> <span class="n">bearerTokenAuthenticator</span><span class="k">:</span> <span class="kt">BearerTokenAuthenticator</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span>, <span class="kt">DummyUser</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

<span class="k">def</span> <span class="n">cookieAuthenticator</span><span class="k">:</span> <span class="kt">SignedCookieAuthenticator</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span>, <span class="kt">DummyUser</span>, <span class="kt">HMACSHA256</span><span class="o">]</span> <span class="k">=</span> <span class="o">???</span>

</code></pre></div>

<p>From here, we can compose them using the method <code class="highlighter-rouge">foldAuthenticate</code>:</p>

<div class="language-scala highlighter-rouge"><pre class="codehilite"><code>     <span class="o">|</span> <span class="cm">/** This turns into a function TSecAuthService =&gt; HttpService **/</span>
     <span class="o">|</span> <span class="k">def</span> <span class="n">folded</span> <span class="k">=</span> <span class="n">jwtAuthenticator</span><span class="o">.</span><span class="n">foldAuthenticate</span><span class="o">(</span><span class="n">bearerTokenAuthenticator</span><span class="o">,</span> <span class="n">cookieAuthenticator</span><span class="o">)</span> <span class="k">_</span>
<span class="n">folded</span><span class="k">:</span> <span class="kt">cats.data.Kleisli</span><span class="o">[[</span><span class="kt">Î²$3$</span><span class="o">]</span><span class="kt">cats.data.OptionT</span><span class="o">[</span><span class="kt">cats.effect.IO</span>,<span class="kt">Î²$3$</span><span class="o">]</span>,<span class="kt">tsec.authentication.SecuredRequest</span><span class="o">[</span><span class="kt">cats.effect.IO</span>,<span class="kt">DummyUser</span>,<span class="kt">tsec.authentication.Authenticator</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span>,<span class="kt">org.http4s.Response</span><span class="o">[</span><span class="kt">cats.effect.IO</span><span class="o">]]</span> <span class="k">=&gt;</span> <span class="n">cats</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="nc">Kleisli</span><span class="o">[[</span><span class="kt">Î²$0$</span><span class="o">]</span><span class="kt">cats.data.OptionT</span><span class="o">[</span><span class="kt">cats.effect.IO</span>,<span class="kt">Î²$0$</span><span class="o">]</span>,<span class="kt">org.http4s.Request</span><span class="o">[</span><span class="kt">cats.effect.IO</span><span class="o">]</span>,<span class="kt">org.http4s.Response</span><span class="o">[</span><span class="kt">cats.effect.IO</span><span class="o">]]</span>
</code></pre></div>

<p>We can then apply it over a service that takes an <code class="highlighter-rouge">Authenticator[I]</code></p>

<div class="language-scala highlighter-rouge"><pre class="codehilite"><code>  <span class="k">val</span> <span class="n">service</span><span class="k">:</span> <span class="kt">TSecAuthService</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">DummyUser</span>, <span class="kt">Authenticator</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">TSecAuthService</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">GET</span> <span class="o">-&gt;</span> <span class="nc">Root</span> <span class="n">asAuthed</span> <span class="k">_</span> <span class="k">=&gt;</span>
      <span class="nc">Ok</span><span class="o">()</span>
  <span class="o">}</span>
</code></pre></div>
<div class="language-scala highlighter-rouge"><pre class="codehilite"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">myService</span><span class="k">:</span> <span class="kt">HttpService</span><span class="o">[</span><span class="kt">IO</span><span class="o">]</span> <span class="k">=</span> <span class="n">folded</span><span class="o">(</span><span class="n">service</span><span class="o">)</span>
<span class="n">myService</span><span class="k">:</span> <span class="kt">org.http4s.HttpService</span><span class="o">[</span><span class="kt">cats.effect.IO</span><span class="o">]</span>
</code></pre></div>

<p>What this does, is that it will try to retrieve the raw format of the first authenticator. i.e, a bearer token string,
or a custom header. If it finds it, it will try to authenticate, or reject. If it is not present, it will try
extracting the raw format of the second authenticator: so on and so forth.</p>

<h2 id="advanced">Advanced</h2>

<p>This is possible because <code class="highlighter-rouge">AuthenticatorService</code> has these two methods:</p>

<div class="language-scala highlighter-rouge"><pre class="codehilite"><code>  <span class="cm">/** Attempt to retrieve the raw representation of an A
    * This is primarily useful when attempting to combine AuthenticatorService,
    * to be able to evaluate an endpoint with more than one token type.
    * or simply just to prod whether the request is malformed.
    *
    * @return
    */</span>
  <span class="k">def</span> <span class="n">extractRawOption</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>

  <span class="cm">/** Parse the raw representation from `extractRawOption`
    *
    */</span>
  <span class="k">def</span> <span class="n">parseRaw</span><span class="o">(</span><span class="n">raw</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">request</span><span class="k">:</span> <span class="kt">Request</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span><span class="k">:</span> <span class="kt">OptionT</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">SecuredRequest</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">V</span>, <span class="kt">A</span><span class="o">]]</span>
</code></pre></div>

<p>In the default case, anything that yields a <code class="highlighter-rouge">Some[String]</code> for <code class="highlighter-rouge">extractRawOption</code> will attempt to authenticate. If
you need anything more complicated, please refer to the <code class="highlighter-rouge">foldAuthenticate</code> method in <code class="highlighter-rouge">Authenticator</code> for a 
reference on how this has to be implemented (it requires an upcast, given Kleisli and Authenticator are invariants, but
such an upcast is correct so long as you only intend to use it to lose information, not to parse an incorrect token
type with it).</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/tsec/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/tsec/js/main.js"></script><script src="/tsec/js/kazari.js"></script><script>
$(document).ready(function() {
	kazari.KazariPlugin().decorateCode('https://scala-evaluator-212.herokuapp.com/eval', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.S2F6YXJp.Jl2eqMfw8IakJF93PjxTbrf-8YUJgX5OoOfy5JHE8Yw', '', 'monokai')
})
    </script></body></html>